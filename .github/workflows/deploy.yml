name: Deploy Azure infra

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write     # necesar pentru OIDC token
      contents: read      # necesar pentru checkout

    steps:
      - name: Pre Azure Login (OIDC)
        run: echo "Starting OIDC loginâ€¦"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      - name: Install Az modules
        uses: azure/powershell@v1
        with:
          inlineScript: |
            Get-Module Az.Accounts -ListAvailable | Select-Object Name, Version
          azPSVersion: latest

      - name: Deploy environment
        uses: azure/powershell@v1
        with:
          inlineScript: |
            ./automation/deploy-environment.ps1 `
              -Env dev `
              -App core `
              -Region weu `
              -Location westeurope
          azPSVersion: latest

      - name: Post Azure Login (OIDC)
        if: always()
        run: echo "Deployment finished."
